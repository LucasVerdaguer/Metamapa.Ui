<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <title>Nueva Solicitud - MetaMapa</title>

    <!-- HEAD GLOBAL -->
    <th:block th:replace="fragments/head :: head"></th:block>

    <link rel="stylesheet" th:href="@{/css/inicioAdminYContribuyente.css}">
</head>
<body>

<th:block th:replace="fragments/header :: header"></th:block>

<main class="container my-5">

    <h3 class="mb-4">Nueva Solicitud</h3>

    <form th:action="@{/contribuyente/nueva-solicitud}" method="post" class="card p-4 shadow-sm" id="formSolicitud">

        <div class="mb-3">
            <label class="form-label fw-bold">Tipo de solicitud</label>
            <select class="form-select" name="tipo" id="tipoSolicitud" required>
                <option value="" disabled selected>Seleccione...</option>
                <option value="ELIMINACION">Eliminación</option>
                <option value="MODIFICACION">Modificación</option>
            </select>
            <small id="tipoInfo" class="text-muted"></small>
        </div>

        <div id="bloqueEliminar" style="display:none;">
            <div class="mb-3">
                <label class="form-label fw-bold">Hecho a eliminar</label>
                <select class="form-select" name="idHecho" id="selectHechoEliminar" disabled>
                    <option disabled selected value="">Seleccione un hecho...</option>
                    <option th:each="h : ${hechosParaEliminar}"
                            th:value="${h.idHecho}"
                            th:text="${h.titulo}">
                    </option>
                </select>
            </div>
        </div>

        <div id="bloqueModificar" style="display:none;">

            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Seleccioná qué dato está incorrecto y proponé el nuevo valor.
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Hecho a corregir</label>
                <select class="form-select" name="idHecho" id="selectHechoModificar" disabled>
                    <option value="" disabled selected>Seleccione un hecho...</option>
                    <option th:each="h : ${misHechos}"
                            th:value="${h.idHecho}"
                            th:text="${h.titulo}">
                    </option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">¿Qué dato querés modificar?</label>
                <select class="form-select" name="campo" id="selectCampo" disabled>
                    <option value="" disabled selected>Seleccioná el campo...</option>
                    <option th:each="c : ${camposDisponibles}"
                            th:value="${c.name()}"
                            th:text="${c.etiqueta}">
                    </option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Valor Correcto (Nuevo)</label>
                <input type="text" class="form-control" name="valorNuevo"
                       placeholder="Escribí aquí el dato corregido..." id="inputValorNuevo" disabled>
            </div>
        </div>

        <div class="mb-3 mt-3">
            <label class="form-label fw-bold">Justificación</label>
            <textarea class="form-control" name="justificacion" rows="4" id="textareaJustificacion" required></textarea>

            <div class="d-flex justify-content-between">
                <small id="mensaje500" class="text-muted">Mínimo 500 caracteres.</small>
                <small id="contadorChars" class="text-muted" style="display:none;">0 / 500</small>
            </div>
        </div>

        <div class="text-end">
            <button class="btn btn-success">Enviar Solicitud</button>
        </div>
    </form>

</main>

<th:block th:replace="fragments/footer :: footer"></th:block>

<input type="hidden" id="inputMensajeExito" th:value="${mensajeExito}">

<div class="modal fade" id="modalExito" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="modal-body">
                <div class="mb-3 text-success">
                    <i class="bi bi-check-circle-fill" style="font-size: 4rem;"></i>
                </div>
                <h4 class="mb-3 fw-bold">¡Solicitud Enviada!</h4>
                <p id="textoMensajeExito" class="mb-4" th:text="${mensajeExito}">
                    Tu solicitud ha sido registrada correctamente.
                </p>
                <button type="button" class="btn btn-success px-4" data-bs-dismiss="modal">
                    Entendido
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JS para lógica de tipo -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const selectTipo = document.getElementById("tipoSolicitud");
        const info = document.getElementById("tipoInfo");

        const bloqueEliminar = document.getElementById("bloqueEliminar");
        const bloqueModificar = document.getElementById("bloqueModificar");

        // Referencias a inputs
        const selectEliminar = document.getElementById("selectHechoEliminar");
        const selectModificar = document.getElementById("selectHechoModificar");
        const selectCampo = document.getElementById("selectCampo");
        const inputValor = document.getElementById("inputValorNuevo");

        // Justificación
        const txtJustificacion = document.getElementById("textareaJustificacion");
        const msg500 = document.getElementById("mensaje500");
        const contador = document.getElementById("contadorChars");

        function toggleForm() {
            const valor = selectTipo.value;

            if (valor === "ELIMINACION") {
                // Visual
                info.innerHTML = "Eliminar un hecho existente.";
                bloqueEliminar.style.display = "block";
                bloqueModificar.style.display = "none";

                // Lógica de Inputs (CLAVE PARA TU DTO)
                selectEliminar.disabled = false;  // SE ENVÍA ESTE
                selectEliminar.required = true;

                selectModificar.disabled = true;  // NO SE ENVÍA
                selectCampo.disabled = true;
                inputValor.disabled = true;

                // Justificación
                msg500.style.display = "block";
                txtJustificacion.setAttribute("minlength", "500");
                contador.style.display = "inline";

            } else if (valor === "MODIFICACION") {
                // Visual
                info.innerHTML = "Corregir un dato de un hecho propio.";
                bloqueEliminar.style.display = "none";
                bloqueModificar.style.display = "block";

                // Lógica de Inputs
                selectEliminar.disabled = true;   // NO SE ENVÍA

                selectModificar.disabled = false; // SE ENVÍA ESTE
                selectModificar.required = true;
                selectCampo.disabled = false;
                selectCampo.required = true;
                inputValor.disabled = false;
                inputValor.required = true;

                // Justificación
                msg500.style.display = "none";
                txtJustificacion.removeAttribute("minlength");
                contador.style.display = "none";

            } else {
                // Estado inicial
                bloqueEliminar.style.display = "none";
                bloqueModificar.style.display = "none";
                selectEliminar.disabled = true;
                selectModificar.disabled = true;
            }
        }

        // Eventos
        selectTipo.addEventListener("change", toggleForm);

        // Inicializar
        toggleForm();

        // (Tu lógica del contador de caracteres sigue igual...)
        txtJustificacion.addEventListener("input", function(){
            if(selectTipo.value === "ELIMINACION"){
                const len = this.value.length;
                contador.innerText = len + " / 500";
                contador.style.color = len < 500 ? "red" : "green";
            }
        });

        const inputExito = document.getElementById('inputMensajeExito');

        // Si el input existe y tiene texto (el controller mandó mensajeExito)
        if (inputExito && inputExito.value && inputExito.value.trim() !== "") {
            const modalElement = document.getElementById('modalExito');
            if (modalElement) {
                // Usamos Bootstrap para abrirlo
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
        }
    });
</script>

</body>
</html>