<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>

    <title>MetaMapa - Hechos</title>

    <!-- HEAD GLOBAL -->
    <th:block th:replace="~{fragments/head :: head}"></th:block>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          crossorigin=""/>

    <!-- FontAwesome (aseguramos que est茅 para los iconos) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/hechos.css}">

    <style>
        /* Ajuste para que los mapas de los modales se vean bien */
        #mapaCrear, #mapaEditar {
            z-index: 1; /* Para que no tape otros elementos del modal si se expande */
        }
        /* Ajuste para el mapa de filtros */
        #mapaFiltro {
            z-index: 0;
        }
    </style>

</head>

<body class="min-h-screen flex flex-col">

<!-- HEADER UNIFICADO -->
<th:block th:replace="~{fragments/header :: header}"></th:block>

<main class="flex-grow max-w-6xl mx-auto mt-8 px-4 pb-10">

    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Hechos</h2>

        <div th:if="${param.pick == null and (session.rol == 'ADMIN' or session.rol == 'CONTRIBUYENTE')}">
            <button id="abrirModalCrear"
                    class="btn-verde-claro inline-flex items-center px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-plus mr-2"></i> Agregar Hecho
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <section class="bg-[var(--color-beige-tarjeta)] rounded-lg shadow-sm p-4 mb-6">
        <form th:action="@{/hechos}" method="get" id="filtrosForm">

            <input type="hidden" name="pick" th:if="${param.pick}" th:value="${param.pick}">
            <input type="hidden" name="returnTo" th:if="${param.returnTo}" th:value="${param.returnTo}">
            <input type="hidden" name="hechos" id="hechosHidden" th:value="${param.hechos}">

            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">

                <!--  NUEVO: MAPA DE FILTRO (Ocupa todo el ancho) -->
                <div class="col-span-1 md:col-span-3 lg:col-span-4 mb-2">
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Filtrar por Ubicaci贸n (Click en el mapa)</label>
                    <div id="mapaFiltro" style="height: 200px; width: 100%; border-radius: 0.375rem; border: 1px solid #d1d5db;"></div>
                </div>
                <!--  FIN NUEVO MAPA -->

                <div class="flex flex-col">
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Tipo</label>
                    <div class="flex items-center gap-3 mt-1">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="modo" value=""
                                   th:checked="${param.modo == null || param.modo[0] == ''}"
                                   class="form-radio text-[var(--c-primary)] h-4 w-4 accent-[#688549]">
                            <span class="ml-1 text-sm text-gray-700">Todos</span>
                        </label>

                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="modo" value="curado"
                                   th:checked="${param.modo != null and param.modo[0] == 'curado'}"
                                   class="form-radio text-[var(--c-primary)] h-4 w-4 accent-[#688549]">
                            <span class="ml-1 text-sm text-gray-700">Curado</span>
                        </label>

                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="modo" value="irrestricto"
                                   th:checked="${param.modo != null and param.modo[0] == 'irrestricto'}"
                                   class="form-radio text-[var(--c-primary)] h-4 w-4 accent-[#688549]">
                            <span class="ml-1 text-sm text-gray-700">Irrestricto</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Categor铆a</label>
                    <input type="text" name="categoria"
                           th:value="${param.categoria}"
                           class="input-basic" placeholder="Categor铆a">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Fecha reporte desde</label>
                    <input type="date" name="fechaReporteDesde"
                           th:value="${param.fechaReporteDesde}"
                           class="input-basic">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Fecha reporte hasta</label>
                    <input type="date" name="fechaReporteHasta"
                           th:value="${param.fechaReporteHasta}"
                           class="input-basic">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Fecha acontecimiento desde</label>
                    <input type="date" name="fechaAcontecimientoDesde"
                           th:value="${param.fechaAcontecimientoDesde}"
                           class="input-basic">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Fecha acontecimiento hasta</label>
                    <input type="date" name="fechaAcontecimientoHasta"
                           th:value="${param.fechaAcontecimientoHasta}"
                           class="input-basic">
                </div>

                <!--  INPUTS LAT/LONG ACTUALIZADOS PARA FILTRO -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Latitud</label>
                    <input id="latitudFiltro" type="number" step="any" name="latitud"
                           th:value="${param.latitud}"
                           class="input-basic" placeholder="Latitud">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Longitud</label>
                    <div class="flex gap-2">
                        <input id="longitudFiltro" type="number" step="any" name="longitud"
                               th:value="${param.longitud}"
                               class="input-basic" placeholder="Longitud">
                        <button type="button" id="btnLimpiarFiltroUbicacion" class="btn-rojo px-3 rounded-md flex items-center justify-center" title="Limpiar ubicaci贸n">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                <!--  FIN INPUTS -->

                <div class="flex flex-col gap-2 mt-2 md:mt-0">
                    <span class="text-xs font-semibold text-gray-700">Acciones</span>
                    <div class="flex gap-3 mt-1">
                        <button class="btn-verde-claro text-sm inline-flex items-center px-3 py-2 rounded-md"
                                type="submit">
                            <i class="fas fa-search mr-1"></i> Buscar
                        </button>
                        <button class="btn-rojo text-sm inline-flex items-center px-3 py-2 rounded-md"
                                type="button" id="btnLimpiarFiltros">
                            <i class="fas fa-broom mr-1"></i> Limpiar filtros
                        </button>
                    </div>
                </div>

            </div>
        </form>
    </section>

    <!-- Mapa General (Resultados) -->
    <section class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <h3 class="text-lg font-semibold mb-3 text-gray-800">Mapa de hechos</h3>
        <div id="mapHechos" class="w-full rounded-md"></div>
    </section>

    <!-- Tabla -->
    <section class="bg-white rounded-lg shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-3 text-gray-800">Hechos encontrados:</h3>

        <div class="overflow-x-auto">
            <table class="min-w-full border-separate border-spacing-y-1 text-sm">

                <thead class="bg-[var(--color-beige-tarjeta)] border-b">
                <tr class="bg-gray-200 text-gray-700 text-left">
                    <th class="p-3 text-center" th:if="${param.pick}">Sel.</th>
                    <th class="p-3 rounded-l-md">ID</th>
                    <th class="p-3">T铆tulo</th>
                    <th class="p-3">Descripci贸n</th>
                    <!--th class="p-3">Tags</th-->
                    <th class="p-3 text-center">Ver Mapa</th>
                    <th class="p-3 text-center" th:if="${param.pick == null and session.rol == 'CONTRIBUYENTE'}">Solicitar Eliminaci贸n</th>
                    <th class="p-3 text-center" th:if="${param.pick == null and session.rol == 'ADMIN'}">Eliminar</th>
                    <th class="p-3 text-center rounded-r-md" th:if="${param.pick == null and (session.rol == 'ADMIN' or session.rol == 'CONTRIBUYENTE')}">Editar</th>
                    <th class="p-3 text-center" th:if="${param.pick == null}">Ver detalle</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="hecho : ${hechos}"
                    class="bg-white shadow-sm hover:bg-gray-50 transition-all hecho-row"
                    th:data-hecho-id="${hecho.id}"
                    th:data-hecho-latitud="${hecho.latitud}"
                    th:data-hecho-longitud="${hecho.longitud}"
                    th:data-hecho-categoria="${hecho.categoria}"
                    th:data-hecho-titulo="${hecho.titulo}"
                    th:data-hecho-descripcion="${hecho.descripcion}"
                    th:data-hecho-contenido="${hecho.urlMultimedia}"
                    th:data-hecho-fecha-acontecimiento="${hecho.fecha}"
                    th:data-hecho-fecha-carga="${hecho.fechaCarga}"
                    th:data-hecho-etiquetas="${#strings.listJoin(hecho.etiquetas, ', ')}"
                    th:data-hecho-consensos="${#strings.listJoin(hecho.consensos, ', ')}"
                    th:data-hecho-consensuado="${hecho.consensuado}"
                    th:data-hecho-fuentes="${#strings.listJoin(hecho.fuentes, ', ')}">

                    <td class="p-3 text-center" th:if="${param.pick}">
                        <input type="checkbox" class="pick-checkbox" th:value="${hecho.id}">
                    </td>

                    <td class="p-3 font-semibold" th:text="${hecho.id}"></td>
                    <td class="p-3 col-titulo leading-snug texto-justificado" th:text="${hecho.titulo}"></td>
                    <td class="p-3 col-descripcion leading-snug texto-justificado" th:text="${hecho.descripcion}"></td>
                    <!--td class="p-3 col-etiquetas">
                        <span th:each="tag : ${hecho.etiquetas}" class="tag" th:text="${tag}"></span>
                    </td-->
                    <td class="p-3 text-center">
                        <button class="btn-icono btn-ver-mapa"><i class="fas fa-map-marker-alt"></i></button>
                    </td>

                    <td class="p-3 text-center" th:if="${param.pick == null and session.rol == 'CONTRIBUYENTE'}">
                        <button class="btn-icono eliminar btn-solicitar-eliminacion"><i class="fas fa-trash-alt"></i></button>
                    </td>

                    <td class="p-3 text-center" th:if="${param.pick == null and session.rol == 'ADMIN'}">
                        <button class="btn-icono eliminar btn-eliminar-admin" th:data-id="${hecho.id}"><i class="fas fa-trash"></i></button>
                    </td>

                    <td class="p-3 text-center" th:if="${param.pick == null and (session.rol == 'ADMIN' or session.rol == 'CONTRIBUYENTE')}">
                        <button class="btn-icono editar btn-editar-hecho" th:if="${session.rol == 'ADMIN'}"><i class="fas fa-pen"></i></button>
                        <button class="btn-icono editar btn-editar-hecho" th:if="${session.rol == 'CONTRIBUYENTE' and hecho.idContribuyente == session.usuarioId}"><i class="fas fa-pen"></i></button>
                        <span class="text-gray-400" th:if="${session.rol == 'CONTRIBUYENTE' and hecho.idContribuyente != session.usuarioId}">-</span>
                    </td>

                    <td class="p-3 text-center" th:if="${param.pick == null}">
                        <button class="btn-icono btn-ver-detalle"><i class="fas fa-eye"></i></button>
                    </td>
                </tr>

                <tr th:if="${hechos == null or #lists.isEmpty(hechos)}">
                    <td colspan="12" class="text-center text-gray-500 py-4">No se encontraron hechos.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Paginaci贸n -->
    <div class="flex flex-wrap items-center justify-between mt-6 gap-4">
        <span class="text-sm text-gray-700" th:text="'P谩gina ' + ${page} + ' de ' + ${totalPages}"></span>

        <form method="get" class="flex items-center gap-2">
            <label class="text-sm text-gray-600">Mostrar:</label>
            <select name="size" class="border rounded-md px-2 py-1 text-sm" onchange="this.form.submit()">
                <option th:selected="${size == 5}" value="5">5</option>
                <option th:selected="${size == 10}" value="10">10</option>
                <option th:selected="${size == 20}" value="20">20</option>
                <option th:selected="${size == 50}" value="50">50</option>
                <option th:selected="${size == 9999}" value="9999">Todos</option>
            </select>
            <!-- Hidden inputs para mantener filtros -->
            <input type="hidden" name="modo" th:value="${param.modo}">
            <input type="hidden" name="categoria" th:value="${param.categoria}">
            <input type="hidden" name="fechaReporteDesde" th:value="${param.fechaReporteDesde}">
            <input type="hidden" name="fechaReporteHasta" th:value="${param.fechaReporteHasta}">
            <input type="hidden" name="fechaAcontecimientoDesde" th:value="${param.fechaAcontecimientoDesde}">
            <input type="hidden" name="fechaAcontecimientoHasta" th:value="${param.fechaAcontecimientoHasta}">
            <input type="hidden" name="latitud" th:value="${param.latitud}">
            <input type="hidden" name="longitud" th:value="${param.longitud}">
            <input type="hidden" name="pick" th:if="${param.pick}" th:value="${param.pick}">
            <input type="hidden" name="hechos" th:if="${param.hechos}" th:value="${param.hechos}">
            <input type="hidden" name="returnTo" th:if="${param.returnTo}" th:value="${param.returnTo}">
        </form>

        <ul class="pagination">
            <li class="page-item" th:classappend="${page == 1} ? ' disabled'">
                <a class="page-link" th:href="@{/hechos(page=${page-2}, size=${size}, modo=${param.modo}, categoria=${param.categoria})}">芦</a>
            </li>
            <li class="page-item" th:classappend="${page == totalPages} ? ' disabled'">
                <a class="page-link" th:href="@{/hechos(page=${page}, size=${size}, modo=${param.modo}, categoria=${param.categoria})}">禄</a>
            </li>
        </ul>
    </div>

    <div th:if="${param.pick}" class="mt-6 flex justify-end gap-3">
        <button id="btnCancelarPick" type="button" class="btn-rojo px-4 py-2 rounded-md text-sm">Cancelar</button>
        <button id="btnConfirmarPick" type="button" class="btn-verde-oscuro px-4 py-2 rounded-md text-sm">Confirmar selecci贸n</button>
    </div>

</main>

<th:block th:replace="~{fragments/footer :: footer}"></th:block>

<!-- Scripts -->
<script th:inline="javascript">
    window.PICK_MODE = /*[[${param.pick != null}]]*/ false;
    window.RETURN_TO = /*[[${param.returnTo}]]*/ null;
    window.HECHOS_INICIALES = /*[[${param.hechos}]]*/ "";
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ========================================================= -->
<!-- MODAL: CREAR HECHO (CON MAPA)                             -->
<!-- ========================================================= -->
<div id="modalCrearHecho" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="cerrarModalCrear">&times;</span>
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Crear Nuevo Hecho</h3>

        <div id="errorCrearHecho" class="text-sm text-red-600 mb-2"></div>

        <form id="formCrearHecho" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">T铆tulo</label>
                <input id="titulo" type="text" class="input-basic" required>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Descripci贸n</label>
                <textarea id="descripcion" rows="3" class="input-basic"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Categor铆a</label>
                <input id="categoria" type="text" class="input-basic" required>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">URL multimedia (opcional)</label>
                <input id="urlMultimedia" type="url" class="input-basic" placeholder="https://...">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Etiquetas (separadas por coma)</label>
                <input id="etiquetas" type="text" class="input-basic" placeholder="accidente, tr谩nsito">
            </div>

            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">Ubicaci贸n (Seleccionar en el mapa)</label>

                <div id="mapaCrear" style="height: 250px; width: 100%; border-radius: 0.375rem; border: 1px solid #d1d5db;" class="mb-3"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Latitud</label>
                        <input id="latitud" type="number" step="any" class="input-basic bg-gray-100" required >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Longitud</label>
                        <div class="flex gap-2">
                            <input id="longitud" type="number" step="any" class="input-basic bg-gray-100" required >
                            <button type="button" id="btnLimpiarUbicacion" class="btn-rojo px-3 rounded-md flex items-center justify-center" title="Limpiar ubicaci贸n">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Fecha del acontecimiento</label>
                <input id="fechaAcontecimiento" type="date" class="input-basic" required>
            </div>

            <div class="flex justify-end gap-3 pt-2">
                <button id="cancelarModalCrear" type="button" class="btn-rojo px-4 py-2 rounded-md text-sm">Cancelar</button>
                <button type="submit" class="btn-verde-oscuro px-4 py-2 rounded-md text-sm">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- ========================================================= -->
<!-- MODAL: EDITAR HECHO (ACTUALIZADO CON MAPA)                -->
<!-- ========================================================= -->
<div id="modalEditarHecho" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="cerrarModalEditar">&times;</span>
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Editar Hecho</h3>
        <div id="errorEditarHecho" class="text-sm text-red-600 mb-2"></div>
        <form id="formEditarHecho" class="space-y-4">
            <input type="hidden" id="idHechoEditar">
            <div><label class="block text-sm font-medium text-gray-700">T铆tulo</label><input id="tituloEditar" type="text" class="input-basic"></div>
            <div><label class="block text-sm font-medium text-gray-700">Descripci贸n</label><textarea id="descripcionEditar" rows="3" class="input-basic"></textarea></div>
            <div><label class="block text-sm font-medium text-gray-700">Categor铆a</label><input id="categoriaEditar" type="text" class="input-basic"></div>
            <div><label class="block text-sm font-medium text-gray-700">URL multimedia</label><input id="urlMultimediaEditar" type="url" class="input-basic"></div>
            <div><label class="block text-sm font-medium text-gray-700">Etiquetas</label><input id="etiquetasEditar" type="text" class="input-basic"></div>

            <!--  NUEVO: MAPA PARA EDITAR -->
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">Ubicaci贸n (Modificar en el mapa)</label>
                <div id="mapaEditar" style="height: 250px; width: 100%; border-radius: 0.375rem; border: 1px solid #d1d5db;" class="mb-3"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Latitud</label>
                        <input id="latitudEditar" type="number" step="any" class="input-basic bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Longitud</label>
                        <input id="longitudEditar" type="number" step="any" class="input-basic bg-gray-100" readonly>
                    </div>
                </div>
            </div>
            <!--  FIN NUEVO MAPA EDITAR -->

            <div><label class="block text-sm font-medium text-gray-700">Fecha</label><input id="fechaEditar" type="date" class="input-basic"></div>
            <div class="flex justify-end gap-3 pt-2">
                <button id="cancelarModalEditar" type="button" class="btn-rojo px-4 py-2 rounded-md text-sm">Cancelar</button>
                <button type="submit" class="btn-verde-oscuro px-4 py-2 rounded-md text-sm">Guardar cambios</button>
            </div>
        </form>
    </div>
</div>

<!-- OTROS MODALES (Detalle, Eliminar, etc.) -->
<div id="modalDetalleHecho" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="cerrarModalDetalle">&times;</span>
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Detalle del hecho</h3>
        <div id="errorDetalleHecho" class="text-sm text-red-600 mb-2"></div>
        <div id="detalleHechoBody" class="space-y-2 text-sm text-gray-800"></div>
        <div class="flex justify-end gap-3 pt-4">
            <button id="cancelarModalDetalle" type="button" class="btn-verde-oscuro px-4 py-2 rounded-md text-sm">Cerrar</button>
        </div>
    </div>
</div>

<div id="modalSolicitudEliminacion" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="cerrarModalSolicitud">&times;</span>
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Solicitar eliminaci贸n</h3>
        <p class="text-sm text-gray-700">Hecho: <span id="tituloHechoSolicitud" class="font-semibold"></span></p>
        <div id="errorSolicitudEliminacion" class="text-sm text-red-600 mb-2"></div>
        <form id="formSolicitudEliminacion" class="space-y-4">
            <input type="hidden" id="idHechoSolicitud">
            <div><label class="block text-sm font-medium text-gray-700">Justificaci贸n</label><textarea id="justificacionSolicitud" rows="4" class="input-basic" required></textarea></div>
            <div class="flex justify-end gap-3 pt-2">
                <button id="cancelarModalSolicitud" type="button" class="btn-rojo px-4 py-2 rounded-md text-sm">Cancelar</button>
                <button type="submit" class="btn-verde-oscuro px-4 py-2 rounded-md text-sm">Enviar solicitud</button>
            </div>
        </form>
    </div>
</div>

<div id="modalConfirmarEliminar" class="modal">
    <div class="modal-content max-w-md mx-auto mt-20 p-6 shadow-xl rounded-lg bg-white">
        <div class="text-center mb-4"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><i class="fas fa-exclamation-triangle text-red-600 text-xl"></i></div><h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">驴Eliminar este hecho?</h3></div>
        <div class="text-center text-sm text-gray-500 mb-6"><p>Esta acci贸n es irreversible.</p></div>
        <div class="flex justify-center gap-3">
            <button id="btnCancelarEliminacion" type="button" class="btn-gris px-4 py-2 rounded-md text-sm font-medium border hover:bg-gray-100">Cancelar</button>
            <button id="btnConfirmarEliminacion" type="button" class="btn-rojo px-4 py-2 rounded-md text-sm font-medium bg-red-600 text-white hover:bg-red-700">S铆, eliminar</button>
        </div>
    </div>
</div>

<div id="modalExitoSimple" class="modal">
    <div class="modal-content max-w-md mx-auto mt-20 p-6 shadow-xl rounded-lg bg-white">
        <div class="text-center">
            <div class="mb-4">
                <i class="fas fa-check-circle text-green-600 text-6xl"></i>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-2">隆Solicitud Enviada!</h3>

            <p class="text-gray-600 mb-6">
                Tu solicitud ha sido registrada correctamente y ser谩 revisada.
            </p>

            <button type="button"
                    class="bg-green-600 text-white px-6 py-2 rounded-full font-bold shadow-md hover:bg-green-700 transition-transform transform hover:scale-105"
                    onclick="window.location.reload()">
                Aceptar
            </button>
        </div>
    </div>
</div>

<!-- JS Principal -->
<script th:src="@{/js/hechos.js}"></script>

<!-- SCRIPT ESPECFICO PARA MAPAS DE CREACIN Y EDICIN -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- MAPA FILTRO ---
        // Se ejecuta al cargar la p谩gina si el div existe
        const mapaFiltroContainer = document.getElementById("mapaFiltro");
        if (mapaFiltroContainer) {
            // Valores iniciales (si vienen de par谩metros)
            const latVal = document.getElementById("latitudFiltro").value;
            const lngVal = document.getElementById("longitudFiltro").value;

            // Coordenadas por defecto (Buenos Aires) si no hay selecci贸n previa
            const defaultCoords = [-34.6037, -58.3816];
            const initialCoords = (latVal && lngVal) ? [parseFloat(latVal), parseFloat(lngVal)] : defaultCoords;
            const initialZoom = (latVal && lngVal) ? 15 : 12;

            const mapFiltro = L.map('mapaFiltro').setView(initialCoords, initialZoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(mapFiltro);

            let markerFiltro = null;
            if (latVal && lngVal) {
                markerFiltro = L.marker(initialCoords).addTo(mapFiltro);
            }

            // Evento Click
            mapFiltro.on('click', (e) => {
                const { lat, lng } = e.latlng;
                document.getElementById("latitudFiltro").value = lat.toFixed(6);
                document.getElementById("longitudFiltro").value = lng.toFixed(6);

                if (markerFiltro) markerFiltro.setLatLng([lat, lng]);
                else markerFiltro = L.marker([lat, lng]).addTo(mapFiltro);
            });

            // Bot贸n Limpiar
            document.getElementById("btnLimpiarFiltroUbicacion")?.addEventListener("click", () => {
                document.getElementById("latitudFiltro").value = "";
                document.getElementById("longitudFiltro").value = "";
                if (markerFiltro) {
                    mapFiltro.removeLayer(markerFiltro);
                    markerFiltro = null;
                }
            });
        }

        // --- MAPA CREAR ---
        let mapCrear = null;
        let markerCrear = null;
        const inputLatCrear = document.getElementById("latitud");
        const inputLngCrear = document.getElementById("longitud");
        const btnLimpiarCrear = document.getElementById("btnLimpiarUbicacion");

        const btnAbrirCrear = document.getElementById("abrirModalCrear");
        if (btnAbrirCrear) {
            btnAbrirCrear.addEventListener("click", () => {
                setTimeout(() => {
                    if (!mapCrear) {
                        const defaultCoords = [-34.6037, -58.3816];
                        mapCrear = L.map('mapaCrear').setView(defaultCoords, 12);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(mapCrear);
                        mapCrear.on('click', (e) => {
                            const { lat, lng } = e.latlng;
                            inputLatCrear.value = lat.toFixed(6);
                            inputLngCrear.value = lng.toFixed(6);
                            if (markerCrear) markerCrear.setLatLng([lat, lng]);
                            else markerCrear = L.marker([lat, lng]).addTo(mapCrear);
                        });
                    }
                    mapCrear.invalidateSize();
                }, 100);
            });
        }

        if (btnLimpiarCrear) {
            btnLimpiarCrear.addEventListener("click", () => {
                inputLatCrear.value = "";
                inputLngCrear.value = "";
                if (markerCrear) { mapCrear.removeLayer(markerCrear); markerCrear = null; }
            });
        }

        const btnCerrarCrear = document.getElementById("cerrarModalCrear");
        const btnCancelarCrear = document.getElementById("cancelarModalCrear");
        const resetMapaCrear = () => { if(markerCrear) { mapCrear.removeLayer(markerCrear); markerCrear = null; } };
        if(btnCerrarCrear) btnCerrarCrear.addEventListener("click", resetMapaCrear);
        if(btnCancelarCrear) btnCancelarCrear.addEventListener("click", resetMapaCrear);


        // --- MAPA EDITAR ---
        let mapEditar = null;
        let markerEditar = null;
        const inputLatEdit = document.getElementById("latitudEditar");
        const inputLngEdit = document.getElementById("longitudEditar");

        // Delegaci贸n de eventos para botones editar (ya que pueden ser muchos)
        const btnsEditar = document.querySelectorAll(".btn-editar-hecho");
        btnsEditar.forEach(btn => {
            btn.addEventListener("click", () => {
                const row = btn.closest("tr");
                const lat = parseFloat(row.dataset.hechoLatitud);
                const lng = parseFloat(row.dataset.hechoLongitud);

                setTimeout(() => {
                    if (!mapEditar) {
                        mapEditar = L.map('mapaEditar');
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(mapEditar);

                        // Click en mapa actualiza inputs y marcador
                        mapEditar.on('click', (e) => {
                            const { lat, lng } = e.latlng;
                            inputLatEdit.value = lat.toFixed(6);
                            inputLngEdit.value = lng.toFixed(6);
                            if (markerEditar) markerEditar.setLatLng([lat, lng]);
                            else markerEditar = L.marker([lat, lng]).addTo(mapEditar);
                        });
                    }
                    mapEditar.invalidateSize();

                    // Posicionar mapa y marcador seg煤n datos existentes
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const loc = [lat, lng];
                        mapEditar.setView(loc, 15);
                        if (markerEditar) markerEditar.setLatLng(loc);
                        else markerEditar = L.marker(loc).addTo(mapEditar);
                    } else {
                        // Default si no tiene ubicaci贸n
                        mapEditar.setView([-34.6037, -58.3816], 12);
                        if(markerEditar) { mapEditar.removeLayer(markerEditar); markerEditar = null; }
                    }
                }, 100);
            });
        });
    });
</script>

</body>
</html>