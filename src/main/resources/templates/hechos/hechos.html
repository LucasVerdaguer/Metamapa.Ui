<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>MetaMapa - Hechos</title>

    <!-- HEAD GLOBAL -->
    <th:block th:replace="fragments/head :: head"></th:block>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          crossorigin=""/>

    <link rel="stylesheet" th:href="@{/css/hechos.css}">
</head>

<body class="min-h-screen flex flex-col">

<!-- HEADER UNIFICADO -->
<th:block th:replace="fragments/header :: header"></th:block>

<main class="flex-grow max-w-6xl mx-auto mt-8 px-4 pb-10">

    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Hechos</h2>

        <div th:if="${param.pick == null and (session.rol == 'ADMIN' or session.rol == 'CONTRIBUYENTE')}">
        <button id="abrirModalCrear"
                    class="btn-verde-claro inline-flex items-center px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-plus mr-2"></i> Agregar Hecho
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <section class="bg-[var(--color-beige-tarjeta)] rounded-lg shadow-sm p-4 mb-6">
        <form th:action="@{/hechos}" method="get" id="filtrosForm">

            <!-- PRESERVAR PICK MODE DURANTE FILTROS                   -->
            <input type="hidden" name="pick" th:if="${param.pick}" th:value="${param.pick}">
            <input type="hidden" name="returnTo" th:if="${param.returnTo}" th:value="${param.returnTo}">
            <input type="hidden" name="hechos" id="hechosHidden"
                   th:value="${param.hechos}">

            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Categoría</label>
                    <input type="text" name="categoria"
                           th:value="${param.categoria}"
                           class="input-basic" placeholder="Categoría">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Fecha reporte desde</label>
                    <input type="date" name="fechaReporteDesde"
                           th:value="${param.fechaReporteDesde}"
                           class="input-basic">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Fecha reporte hasta</label>
                    <input type="date" name="fechaReporteHasta"
                           th:value="${param.fechaReporteHasta}"
                           class="input-basic">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Fecha acontecimiento desde</label>
                    <input type="date" name="fechaAcontecimientoDesde"
                           th:value="${param.fechaAcontecimientoDesde}"
                           class="input-basic">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Fecha acontecimiento hasta</label>
                    <input type="date" name="fechaAcontecimientoHasta"
                           th:value="${param.fechaAcontecimientoHasta}"
                           class="input-basic">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Latitud</label>
                    <input type="number" step="any" name="latitud"
                           th:value="${param.latitud}"
                           class="input-basic" placeholder="Latitud">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Longitud</label>
                    <input type="number" step="any" name="longitud"
                           th:value="${param.longitud}"
                           class="input-basic" placeholder="Longitud">
                </div>

                <div class="flex flex-col gap-2 mt-2 md:mt-0">
                    <span class="text-xs font-semibold text-gray-700">Acciones</span>
                    <div class="flex gap-3 mt-1">
                        <button class="btn-verde-claro text-sm inline-flex items-center px-3 py-2 rounded-md"
                                type="submit">
                            <i class="fas fa-search mr-1"></i> Buscar
                        </button>
                        <button class="btn-rojo text-sm inline-flex items-center px-3 py-2 rounded-md"
                                type="button" id="btnLimpiarFiltros">
                            <i class="fas fa-broom mr-1"></i> Limpiar filtros
                        </button>
                    </div>
                </div>

            </div>

        </form>
    </section>

    <!-- Mapa -->
    <section class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <h3 class="text-lg font-semibold mb-3 text-gray-800">Mapa de hechos</h3>
        <div id="mapHechos" class="w-full rounded-md"></div>
    </section>

    <!-- Tabla -->
    <section class="bg-white rounded-lg shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-3 text-gray-800">Hechos encontrados:</h3>

        <div class="overflow-x-auto">
            <table class="min-w-full border-separate border-spacing-y-1 text-sm">

                <thead class="bg-[var(--color-beige-tarjeta)] border-b">
                <tr class="bg-gray-200 text-gray-700 text-left">

                    <th class="p-3 text-center" th:if="${param.pick}">Sel.</th>
                    <th class="p-3 rounded-l-md">ID</th>
                    <th class="p-3">Título</th>
                    <th class="p-3">Descripción</th>
                    <th class="p-3">Tags</th>

                    <th class="p-3 text-center">Ver Mapa</th>

                    <th class="p-3 text-center"
                        th:if="${param.pick == null and session.rol == 'CONTRIBUYENTE'}">Solicitar Eliminación</th>

                    <th class="p-3 text-center"
                        th:if="${param.pick == null and session.rol == 'ADMIN'}">Eliminar</th>

                    <th class="p-3 text-center rounded-r-md"
                        th:if="${param.pick == null and session.rol == 'ADMIN' or session.rol == 'CONTRIBUYENTE'}">Editar</th>

                </tr>
                </thead>

                <tbody>
                <tr th:each="hecho : ${hechos}"
                    class="bg-white shadow-sm hover:bg-gray-50 transition-all hecho-row"
                    th:data-hecho-id="${hecho.idHecho}"
                    th:data-hecho-latitud="${hecho.latitud}"
                    th:data-hecho-longitud="${hecho.longitud}"
                    th:data-hecho-categoria="${hecho.categoria}">

                    <!-- PICK MODE: checkbox -->
                    <td class="p-3 text-center" th:if="${param.pick}">
                        <input type="checkbox" class="pick-checkbox"
                               th:value="${hecho.idHecho}">
                    </td>

                    <!-- ID -->
                    <td class="p-3 font-semibold" th:text="${hecho.idHecho}"></td>

                    <!-- Título -->
                    <td class="p-3 col-titulo leading-snug texto-justificado"
                        th:text="${hecho.titulo}"></td>

                    <!-- Descripción -->
                    <td class="p-3 col-descripcion leading-snug texto-justificado"
                        th:text="${hecho.descripcion}"></td>

                    <!-- Etiquetas -->
                    <td class="p-3 col-etiquetas">
                        <span th:each="tag : ${hecho.etiquetas}"
                              class="tag"
                              th:text="${tag}">
                        </span>
                    </td>

                    <!-- Ver mapa (SIEMPRE visible, incluso en pick mode) -->
                    <td class="p-3 text-center">
                        <button class="btn-icono btn-ver-mapa">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </td>

                    <!-- Solicitar eliminación (solo contribuyente y NO en pick mode) -->
                    <td class="p-3 text-center"
                        th:if="${param.pick == null and session.rol == 'CONTRIBUYENTE'}">
                        <button class="btn-icono eliminar btn-solicitar-eliminacion">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>

                    <!-- Eliminar (solo admin y NO pick) -->
                    <td class="p-3 text-center"
                        th:if="${param.pick == null and session.rol == 'ADMIN'}">
                        <button class="btn-icono eliminar btn-eliminar-admin">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>

                    <!-- Editar (solo si no estamos en pick) -->
                    <td class="p-3 text-center" th:if="${param.pick == null}">

                        <!-- ADMIN siempre puede -->
                        <button class="btn-icono editar btn-editar-hecho"
                                th:if="${session.rol == 'ADMIN'}">
                            <i class="fas fa-pen"></i>
                        </button>

                        <!-- CONTRIBUYENTE si es dueño -->
                        <button class="btn-icono editar btn-editar-hecho"
                                th:if="${session.rol == 'CONTRIBUYENTE'
                                        and hecho.idContribuyente != null
                                        and hecho.idContribuyente == session.usuarioId}">
                            <i class="fas fa-pen"></i>
                        </button>

                        <!-- caso contrario -->
                        <span class="text-gray-400"
                              th:if="${session.rol != null
                                     and !(session.rol == 'ADMIN'
                                     or (session.rol == 'CONTRIBUYENTE'
                                         and hecho.idContribuyente != null
                                         and hecho.idContribuyente == session.usuarioId))}">
                            -
                        </span>

                    </td>
                </tr>

                <!-- Si no hay hechos -->
                <tr th:if="${hechos == null or #lists.isEmpty(hechos)}">
                    <td colspan="7" class="text-center text-gray-500 py-4">
                        No se encontraron hechos.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <div class="flex flex-wrap items-center justify-between mt-6 gap-4">

        <!-- Texto Página X de X -->
        <span class="text-sm text-gray-700"
              th:text="'Página ' + ${page} + ' de ' + ${totalPages}">
    </span>

        <!-- Selector de cantidad por página -->
        <form method="get" class="flex items-center gap-2">
            <label class="text-sm text-gray-600">Mostrar:</label>

            <select name="size"
                    class="border rounded-md px-2 py-1 text-sm"
                    onchange="this.form.submit()">

                <option th:selected="${size == 5}" value="5">5</option>
                <option th:selected="${size == 10}" value="10">10</option>
                <option th:selected="${size == 20}" value="20">20</option>
                <option th:selected="${size == 50}" value="50">50</option>
                <option th:selected="${size == 9999}" value="9999">Todos</option>

            </select>

            <!-- Mantener filtros -->
            <input type="hidden" name="categoria" th:value="${param.categoria}">
            <input type="hidden" name="fechaReporteDesde" th:value="${param.fechaReporteDesde}">
            <input type="hidden" name="fechaReporteHasta" th:value="${param.fechaReporteHasta}">
            <input type="hidden" name="fechaAcontecimientoDesde" th:value="${param.fechaAcontecimientoDesde}">
            <input type="hidden" name="fechaAcontecimientoHasta" th:value="${param.fechaAcontecimientoHasta}">
            <input type="hidden" name="latitud" th:value="${param.latitud}">
            <input type="hidden" name="longitud" th:value="${param.longitud}">
        </form>

        <!-- Botones de paginación -->
        <ul class="pagination">

            <!-- ANTERIOR -->
            <li class="page-item"
                th:classappend="${page == 1} ? ' disabled'">
                <a class="page-link"
                   th:href="@{/hechos(
           page=${page-2}, size=${size},
           categoria=${param.categoria},
           fechaReporteDesde=${param.fechaReporteDesde},
           fechaReporteHasta=${param.fechaReporteHasta},
           fechaAcontecimientoDesde=${param.fechaAcontecimientoDesde},
           fechaAcontecimientoHasta=${param.fechaAcontecimientoHasta},
           latitud=${param.latitud}, longitud=${param.longitud},
           pick=${param.pick},
           returnTo=${param.returnTo},
           hechos=${param.hechos}
       )}">
                    «
                </a>
            </li>

            <!-- PÁGINA 1 -->
            <li class="page-item" th:if="${page > 3}">
                <a class="page-link"
                   th:href="@{/hechos(
           page=0, size=${size},
           categoria=${param.categoria},
           fechaReporteDesde=${param.fechaReporteDesde},
           fechaReporteHasta=${param.fechaReporteHasta},
           fechaAcontecimientoDesde=${param.fechaAcontecimientoDesde},
           fechaAcontecimientoHasta=${param.fechaAcontecimientoHasta},
           latitud=${param.latitud}, longitud=${param.longitud},
           pick=${param.pick},
           returnTo=${param.returnTo},
           hechos=${param.hechos}
       )}">
                    1
                </a>
            </li>

            <!-- "..." PREV -->
            <li class="page-item disabled" th:if="${page > 4}">
                <span class="page-link">…</span>
            </li>

            <!-- RANGO CENTRAL -->
            <li class="page-item"
                th:each="i : ${#numbers.sequence(page-3, page+3)}"
                th:if="${i >= 0 and i < totalPages}"
                th:classappend="${page} == ${i+1} ? ' active'">
                <a class="page-link"
                   th:text="${i+1}"
                   th:href="@{/hechos(
           page=${i}, size=${size},
           categoria=${param.categoria},
           fechaReporteDesde=${param.fechaReporteDesde},
           fechaReporteHasta=${param.fechaReporteHasta},
           fechaAcontecimientoDesde=${param.fechaAcontecimientoDesde},
           fechaAcontecimientoHasta=${param.fechaAcontecimientoHasta},
           latitud=${param.latitud}, longitud=${param.longitud},
           pick=${param.pick},
           returnTo=${param.returnTo},
           hechos=${param.hechos}
       )}"></a>
            </li>

            <!-- "..." NEXT -->
            <li class="page-item disabled" th:if="${page < totalPages - 3}">
                <span class="page-link">…</span>
            </li>

            <!-- ÚLTIMA -->
            <li class="page-item" th:if="${page < totalPages - 2}">
                <a class="page-link"
                   th:text="${totalPages}"
                   th:href="@{/hechos(
           page=${totalPages-1}, size=${size},
           categoria=${param.categoria},
           fechaReporteDesde=${param.fechaReporteDesde},
           fechaReporteHasta=${param.fechaReporteHasta},
           fechaAcontecimientoDesde=${param.fechaAcontecimientoDesde},
           fechaAcontecimientoHasta=${param.fechaAcontecimientoHasta},
           latitud=${param.latitud}, longitud=${param.longitud},
           pick=${param.pick},
           returnTo=${param.returnTo},
           hechos=${param.hechos}
       )}">
                </a>
            </li>

            <!-- SIGUIENTE -->
            <li class="page-item"
                th:classappend="${page == totalPages} ? ' disabled'">
                <a class="page-link"
                   th:href="@{/hechos(
           page=${page}, size=${size},
           categoria=${param.categoria},
           fechaReporteDesde=${param.fechaReporteDesde},
           fechaReporteHasta=${param.fechaReporteHasta},
           fechaAcontecimientoDesde=${param.fechaAcontecimientoDesde},
           fechaAcontecimientoHasta=${param.fechaAcontecimientoHasta},
           latitud=${param.latitud}, longitud=${param.longitud},
           pick=${param.pick},
           returnTo=${param.returnTo},
           hechos=${param.hechos}
       )}">
                    »
                </a>
            </li>
        </ul>
    </div>

    <div th:if="${param.pick}" class="mt-6 flex justify-end">
        <button id="btnConfirmarPick"
                class="btn-verde-oscuro px-4 py-2 rounded-md text-sm">
            Confirmar selección
        </button>
    </div>
</main>

<!-- FOOTER -->
<th:block th:replace="fragments/footer :: footer"></th:block>

<!-- PICK HECHOS Y JWT -->
<script th:inline="javascript">
    window.PICK_MODE = /*[[${param.pick != null}]]*/ false;
    window.RETURN_TO = /*[[${param.returnTo}]]*/ null;
    window.HECHOS_INICIALES = /*[[${param.hechos}]]*/ "";
    window.JWT = /*[[${session.jwt}]]*/ "";
</script>



<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ========================================================= -->
<!-- MODAL: CREAR HECHO                                        -->
<!-- ========================================================= -->
<div id="modalCrearHecho" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="cerrarModalCrear">&times;</span>
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Crear Nuevo Hecho</h3>

        <div id="errorCrearHecho" class="text-sm text-red-600 mb-2"></div>

        <form id="formCrearHecho" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Título</label>
                <input id="titulo" type="text" class="input-basic" required>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Descripción</label>
                <textarea id="descripcion" rows="3" class="input-basic"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Categoría</label>
                <input id="categoria" type="text" class="input-basic" required>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">URL multimedia (opcional)</label>
                <input id="urlMultimedia" type="url" class="input-basic" placeholder="https://...">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Etiquetas (separadas por coma)</label>
                <input id="etiquetas" type="text" class="input-basic" placeholder="accidente, tránsito">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Latitud</label>
                    <input id="latitud" type="number" step="any" class="input-basic" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Longitud</label>
                    <input id="longitud" type="number" step="any" class="input-basic" required>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Fecha del acontecimiento</label>
                <input id="fecha" type="date" class="input-basic" required>
            </div>

            <div class="flex justify-end gap-3 pt-2">
                <button id="cancelarModalCrear"
                        type="button" class="btn-rojo px-4 py-2 rounded-md text-sm">
                    Cancelar
                </button>

                <button type="submit"
                        class="btn-verde-oscuro px-4 py-2 rounded-md text-sm">
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ========================================================= -->
<!-- MODAL: EDITAR HECHO                                       -->
<!-- ========================================================= -->
<div id="modalEditarHecho" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="cerrarModalEditar">&times;</span>
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Editar Hecho</h3>

        <div id="errorEditarHecho" class="text-sm text-red-600 mb-2"></div>

        <form id="formEditarHecho" class="space-y-4">
            <input type="hidden" id="idHechoEditar">

            <div>
                <label class="block text-sm font-medium text-gray-700">Título</label>
                <input id="tituloEditar" type="text" class="input-basic">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Descripción</label>
                <textarea id="descripcionEditar" rows="3" class="input-basic"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Categoría</label>
                <input id="categoriaEditar" type="text" class="input-basic">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">URL multimedia</label>
                <input id="urlMultimediaEditar" type="url" class="input-basic" placeholder="https://...">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Etiquetas</label>
                <input id="etiquetasEditar" type="text" class="input-basic">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Latitud</label>
                    <input id="latitudEditar" type="number" step="any" class="input-basic">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Longitud</label>
                    <input id="longitudEditar" type="number" step="any" class="input-basic">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Fecha del acontecimiento</label>
                <input id="fechaEditar" type="date" class="input-basic">
            </div>

            <div class="flex justify-end gap-3 pt-2">
                <button id="cancelarModalEditar"
                        type="button" class="btn-rojo px-4 py-2 rounded-md text-sm">
                    Cancelar
                </button>

                <button type="submit"
                        class="btn-verde-oscuro px-4 py-2 rounded-md text-sm">
                    Guardar cambios
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ========================================================= -->
<!-- MODAL: SOLICITAR ELIMINACIÓN                              -->
<!-- ========================================================= -->
<div id="modalSolicitudEliminacion" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="cerrarModalSolicitud">&times;</span>
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Solicitar eliminación</h3>

        <p class="text-sm text-gray-700">
            Hecho: <span id="tituloHechoSolicitud" class="font-semibold"></span>
        </p>

        <div id="errorSolicitudEliminacion" class="text-sm text-red-600 mb-2"></div>

        <form id="formSolicitudEliminacion" class="space-y-4">
            <input type="hidden" id="idHechoSolicitud">

            <div>
                <label class="block text-sm font-medium text-gray-700">Justificación</label>
                <textarea id="justificacionSolicitud" rows="4"
                          class="input-basic" required
                          placeholder="Explicá por qué debería eliminarse este hecho"></textarea>
            </div>

            <div class="flex justify-end gap-3 pt-2">
                <button id="cancelarModalSolicitud"
                        type="button" class="btn-rojo px-4 py-2 rounded-md text-sm">
                    Cancelar
                </button>

                <button type="submit"
                        class="btn-verde-oscuro px-4 py-2 rounded-md text-sm">
                    Enviar solicitud
                </button>
            </div>
        </form>
    </div>
</div>

<!-- JS para esta página -->
<script th:src="@{/js/hechos.js}"></script>

</body>
</html>