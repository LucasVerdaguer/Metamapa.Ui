<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMapa - Hechos</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        :root {
            --color-verde-oscuro: #4a5c36;
            --color-verde-claro: #8b9d62;
            --color-beige-fondo: #f3ecd4;
            --color-beige-tarjeta: #f7f1dd;
            --color-rojo-boton: #b94a48;
        }

        body {
            background-color: var(--color-beige-fondo);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .btn-base {
            @apply inline-flex items-center justify-center px-4 py-2 rounded-md text-sm font-medium;
        }

        .btn-verde-oscuro {
            background-color: var(--color-verde-oscuro);
            color: #fff;
        }

        .btn-verde-oscuro:hover {
            filter: brightness(0.95);
        }

        .btn-verde-claro {
            background-color: var(--color-verde-claro);
            color: #fff;
        }

        .btn-verde-claro:hover {
            filter: brightness(0.95);
        }

        .btn-rojo {
            background-color: var(--color-rojo-boton);
            color: #fff;
        }

        .btn-rojo:hover {
            filter: brightness(0.95);
        }

        .btn-icono {
            @apply inline-flex items-center justify-center w-8 h-8 rounded-md bg-white border;
            border-color: #e5e7eb;
        }

        .btn-icono.ver-mapa {
            color: var(--color-verde-oscuro);
        }

        .btn-icono.eliminar {
            color: var(--color-rojo-boton);
        }

        .btn-icono.editar {
            color: var(--color-verde-claro);
        }

        .btn-icono:hover {
            filter: brightness(0.95);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 600px;
            width: 95%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .close-btn {
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #6b7280;
        }

        .close-btn:hover {
            color: #111827;
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header class="bg-[var(--color-verde-oscuro)] text-white py-3">
    <div class="max-w-6xl mx-auto flex items-center justify-between px-4">
        <div class="flex items-center gap-2">
            <span class="font-bold text-xl">MetaMapa</span>
        </div>
        <span class="text-sm">Español (AR)</span>
    </div>
</header>

<main class="max-w-6xl mx-auto mt-8 px-4 pb-10">
    <!-- Título + botón agregar -->
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Hechos</h2>
        <button type="button"
                id="abrirModalCrear"
                class="btn-base btn-verde-claro">
            <i class="fas fa-plus mr-2"></i> Agregar Hecho
        </button>
    </div>

    <!-- Tarjeta de filtros SOLO de hechos -->
    <section class="bg-[var(--color-beige-tarjeta)] rounded-lg shadow-sm p-4 mb-6">
        <!-- GET /hechos/hechos -> el controller UI llama al back /hechos con estos params -->
        <form th:action="@{/hechos/hechos}" method="get" id="filtrosForm">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">

                <!-- Categoría -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        Categoría
                    </label>
                    <input type="text"
                           name="categoria"
                           th:value="${param.categoria}"
                           class="w-full px-3 py-2 rounded-md border border-gray-300 text-sm"
                           placeholder="Categoría">
                </div>

                <!-- Fecha reporte desde -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        Fecha reporte desde
                    </label>
                    <input type="date"
                           name="fechaReporteDesde"
                           th:value="${param.fechaReporteDesde}"
                           class="w-full px-3 py-2 rounded-md border border-gray-300 text-sm">
                </div>

                <!-- Fecha reporte hasta -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        Fecha reporte hasta
                    </label>
                    <input type="date"
                           name="fechaReporteHasta"
                           th:value="${param.fechaReporteHasta}"
                           class="w-full px-3 py-2 rounded-md border border-gray-300 text-sm">
                </div>

                <!-- Fecha acontecimiento desde -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        Fecha acontecimiento desde
                    </label>
                    <input type="date"
                           name="fechaAcontecimientoDesde"
                           th:value="${param.fechaAcontecimientoDesde}"
                           class="w-full px-3 py-2 rounded-md border border-gray-300 text-sm">
                </div>

                <!-- Fecha acontecimiento hasta -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        Fecha acontecimiento hasta
                    </label>
                    <input type="date"
                           name="fechaAcontecimientoHasta"
                           th:value="${param.fechaAcontecimientoHasta}"
                           class="w-full px-3 py-2 rounded-md border border-gray-300 text-sm">
                </div>

                <!-- Latitud -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        Latitud
                    </label>
                    <input type="number"
                           step="any"
                           name="latitud"
                           th:value="${param.latitud}"
                           class="w-full px-3 py-2 rounded-md border border-gray-300 text-sm"
                           placeholder="Latitud">
                </div>

                <!-- Longitud -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        Longitud
                    </label>
                    <input type="number"
                           step="any"
                           name="longitud"
                           th:value="${param.longitud}"
                           class="w-full px-3 py-2 rounded-md border border-gray-300 text-sm"
                           placeholder="Longitud">
                </div>

                <!-- Botones -->
                <div class="flex flex-col gap-2 mt-2 md:mt-0">
                    <span class="text-xs font-semibold text-gray-700">Acciones</span>
                    <div class="flex gap-3 mt-1">
                        <button class="btn-base btn-verde-oscuro text-sm" type="submit">
                            <i class="fas fa-search mr-1"></i> Buscar
                        </button>
                        <button class="btn-base btn-rojo text-sm" type="button" id="btnLimpiarFiltros">
                            <i class="fas fa-broom mr-1"></i> Limpiar filtros
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </section>



    <!-- Tabla de hechos -->
    <section class="bg-white rounded-lg shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-3 text-gray-800">Hechos encontrados:</h3>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="border-b">
                <tr class="text-left text-gray-600">
                    <th class="py-2 px-2">Título</th>
                    <th class="py-2 px-2">Descripción</th>
                    <th class="py-2 px-2">Tags</th>
                    <th class="py-2 px-2 text-center">Ver en mapa</th>
                    <th class="py-2 px-2 text-center">Solicitar eliminación</th>
                    <th class="py-2 px-2 text-center">Editar</th>
                </tr>
                </thead>
                <tbody>
                <!-- Itera hechos del modelo -->
                <tr th:each="hecho : ${hechos}"
                    class="border-b last:border-0 hover:bg-gray-50">
                    <td class="py-2 px-2" th:text="${hecho.titulo}">Título</td>
                    <td class="py-2 px-2" th:text="${hecho.descripcion}">Descripción</td>
                    <td class="py-2 px-2">
                        <span th:each="tag : ${hecho.etiquetas}"
                              class="inline-block bg-gray-200 text-xs px-2 py-1 rounded mr-1 mb-1"
                              th:text="${tag}">tag</span>
                    </td>
                    <td class="py-2 px-2 text-center">
                        <button class="btn-icono ver-mapa" title="Ver en mapa" type="button">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </td>
                    <td class="py-2 px-2 text-center">
                        <button class="btn-icono eliminar" title="Solicitar eliminación" type="button">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                    <td class="py-2 px-2 text-center">
                        <button class="btn-icono editar" title="Editar" type="button">
                            <i class="fas fa-pen"></i>
                        </button>
                    </td>
                </tr>

                <!-- Mensaje si no hay hechos -->
                <tr th:if="${hechos == null or #lists.isEmpty(hechos)}"
                    class="border-t">
                    <td class="py-4 px-2 text-center text-gray-500" colspan="6">
                        No se encontraron hechos para los filtros seleccionados.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
</main>

<!-- MODAL: AGREGAR HECHO -->
<div id="modalCrearHecho" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="cerrarModalCrear">&times;</span>
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Crear Nuevo Hecho</h3>

        <!-- acá mostramos errores de creación -->
        <div id="errorCrearHecho" class="text-sm text-red-600 mb-2"></div>

        <!-- Formulario solo manejado por JS -->
        <form id="formCrearHecho" class="space-y-4">
            <!-- Título -->
            <div>
                <label for="titulo" class="block text-sm font-medium text-gray-700">Título</label>
                <input type="text"
                       id="titulo"
                       name="titulo"
                       required
                       class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[var(--color-verde-oscuro)]">
            </div>

            <!-- Categoría -->
            <div>
                <label for="categoria" class="block text-sm font-medium text-gray-700">Categoría</label>
                <input type="text"
                       id="categoria"
                       name="categoria"
                       required
                       class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[var(--color-verde-oscuro)]">
            </div>

            <!-- Latitud / Longitud -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="latitud" class="block text-sm font-medium text-gray-700">Latitud</label>
                    <input type="number"
                           step="any"
                           id="latitud"
                           name="latitud"
                           required
                           class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[var(--color-verde-oscuro)]">
                </div>
                <div>
                    <label for="longitud" class="block text-sm font-medium text-gray-700">Longitud</label>
                    <input type="number"
                           step="any"
                           id="longitud"
                           name="longitud"
                           required
                           class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[var(--color-verde-oscuro)]">
                </div>
            </div>

            <!-- Fecha -->
            <div>
                <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                <input type="date"
                       id="fecha"
                       name="fecha"
                       required
                       class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[var(--color-verde-oscuro)]">
            </div>

            <!-- Botones -->
            <div class="flex justify-end gap-2 pt-2">
                <button type="button"
                        id="cancelarModalCrear"
                        class="btn-base btn-rojo">
                    Cancelar
                </button>
                <button type="submit"
                        class="btn-base btn-verde-oscuro">
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- JS para modal + filtros -->
<script>
    (function () {
        const modal = document.getElementById("modalCrearHecho");
        const btnAbrir = document.getElementById("abrirModalCrear");
        const btnCerrar = document.getElementById("cerrarModalCrear");
        const btnCancelar = document.getElementById("cancelarModalCrear");
        const form = document.getElementById("formCrearHecho");
        const errorBox = document.getElementById("errorCrearHecho");

        // Endpoint del back para crear hecho
        const urlCrearHecho = "http://localhost:8080/fuente-dinamica/hechos/crear";

        function abrir() {
            modal.style.display = "block";
        }

        function cerrar() {
            modal.style.display = "none";
            if (errorBox) {
                errorBox.textContent = "";
            }
            if (form) {
                form.reset();
            }
        }

        if (btnAbrir)   btnAbrir.addEventListener("click", abrir);
        if (btnCerrar)  btnCerrar.addEventListener("click", cerrar);
        if (btnCancelar) btnCancelar.addEventListener("click", function (e) {
            e.preventDefault();
            cerrar();
        });

        // Cerrar haciendo clic fuera del contenido
        window.addEventListener("click", function (event) {
            if (event.target === modal) {
                cerrar();
            }
        });

        // Envío del formulario por fetch
        if (form) {
            form.addEventListener("submit", function (e) {
                e.preventDefault();

                const payload = {
                    titulo:   document.getElementById("titulo").value,
                    categoria: document.getElementById("categoria").value,
                    latitud:  parseFloat(document.getElementById("latitud").value),
                    longitud: parseFloat(document.getElementById("longitud").value),
                    fecha:    document.getElementById("fecha").value
                };

                fetch(urlCrearHecho, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                })
                    .then(resp => {
                        if (!resp.ok) {
                            return resp.text().then(t => {
                                throw new Error(t || ("HTTP " + resp.status));
                            });
                        }
                        return resp.json().catch(() => null);
                    })
                    .then(() => {
                        cerrar();
                        // volvemos a la pantalla de hechos
                        window.location.href = "/hechos/hechos";
                    })
                    .catch(err => {
                        console.error(err);
                        if (errorBox) {
                            errorBox.textContent = "Error al crear hecho: " + err.message;
                        }
                    });
            });
        }

        // ----- LÓGICA DE FILTROS -----
        const btnLimpiarFiltros = document.getElementById("btnLimpiarFiltros");

        // Limpiar filtros => volver a /hechos/hechos sin parámetros
        if (btnLimpiarFiltros) {
            btnLimpiarFiltros.addEventListener("click", function () {
                window.location.href = "/hechos/hechos";
            });
        }
    })();
</script>

</body>
</html>
